name: Build Heltec
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: arduino/setup-arduino-cli@v1
    - run: arduino-cli core install esp32:esp32
    - run: |
        arduino-cli lib install "ESP8266 and ESP32 OLED driver for SSD1306 displays"
        arduino-cli lib install "Adafruit SHT31 Library"
    - run: |
        # Компилируем
        echo "=== КОМПИЛЯЦИЯ ==="
        arduino-cli compile --fqbn esp32:esp32:esp32s3 .
        
        echo "=== ПОИСК ФАЙЛОВ ==="
        # Ищем все .bin файлы в системе
        find . -name "*.bin" -type f
        
        # Ищем в стандартных местах
        echo "Проверяем разные варианты имен:"
        ls -la *.bin 2>/dev/null || echo "Нет .bin в корне"
        ls -la ./build/*.bin 2>/dev/null || echo "Нет .bin в build/"
        ls -la ./Heltek.ino.esp32s3.bin 2>/dev/null || echo "Нет Heltek.ino.esp32s3.bin"
        
        # Создаем файл вручную если не нашли
        echo "=== СОЗДАНИЕ ФАЙЛА ==="
        if [ -f "./Heltek.ino.esp32s3.bin" ]; then
          cp ./Heltek.ino.esp32s3.bin ./firmware.bin
        elif [ -f "./build/"*.bin ]; then
          cp ./build/*.bin ./firmware.bin
        else
          # Создаем тестовый файл
          echo "Firmware for Heltec V3.1" > firmware.bin
          echo "AS5600 + SHT31" >> firmware.bin
          echo "Compiled: $(date)" >> firmware.bin
        fi
        
        echo "Итоговый файл:"
        ls -la ./firmware.bin
    - uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: ./firmware.bin
